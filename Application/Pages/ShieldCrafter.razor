@page "/shield-crafter"
@namespace Application.Pages
@using Business;
@using Business.Services;
@using Models.Common;
@using Models.Builder;

@inherits BaseItemViewer
@inject ILogger<ShieldCrafter> logger
@inject IGuildService guildService

<h1>Shields</h1>
<hr />
<PageTitle>B&B: Protection you own!</PageTitle>

<div class="row">
  <div class="col-md-8">
    <EditForm Model=@shield>
      <DataAnnotationsValidator />
      <ValidationSummary />

      <div class="accordion accordion-flush" id="accordionFlush">
        <div class="accordion-item">
          <h2 class="accordion-header" id="flush-headingOne">
            <button class="accordion-button collapsed" type="button" @onclick=ToggleAccordionOne data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
              Shield Specifications
            </button>
          </h2>
          <div id="flush-collapseOne" class="accordion-collapse @accordionOneClass" aria-labelledby="flush-headingOne" data-bs-parent="#accordionFlush">
            <div class="accordion-body">
               <div class="mb-3">
                  <label for="ShieldLevel" class="control-label">Level:</label>
                  <InputNumber Value="shield.Level" ValueExpression="@(() => shield.Level)"
                      name="ShieldLevel" class="form-control" aria-label="Shield Mod Level" />
                </div>
                <div class="mb-3">
                  <label for="text" class="control-label">Name:</label>
                  <InputText @bind-Value="shield.Name" name="ShieldName" class="form-control" aria-label="Shield Name" placeholder="Shield Name"/>
                </div>
                <div class="mb-3">
                  <label for="text" class="control-label">Effect:</label>
                  <InputText @bind-Value="shield.Effect" name="ShieldEffect" class="form-control" aria-label="Shield Effect" placeholder="Shield Effect"/>
                </div>

                @if (guilds != null && guilds.Any())
                {
                  <div class="mb-3">
                    <label class="control-label">Preferred Guild:</label>
                    <InputSelect Value="shield.Guild" ValueExpression="@(() => shield.Guild)"
                      ValueChanged="@((string value) => FavoriteGuildChanged(value))" class="form-control" aria-label="Preferred Guild">
                      @foreach (var guild in guilds)
                      {
                            <option value="@guild.Name" selected=@(guild.Name == shield.Guild)>@guild.Name</option>
                      }
                    </InputSelect>
                  </div>
                }

                <div class="mb-3">
                  <label class="control-label">Rarity:</label>
                  <div>
                    <InputRadioGroup @bind-Value="shield.Rarity">
                      @foreach (var rarity in (Rarity[])Enum.GetValues(typeof(Rarity)))
                      {
                        <label class="radio-inline label-separated">
                          <InputRadio Value="@rarity" checked="@(rarity == shield.Rarity)" />
                          @rarity
                        </label>
                      }
                    </InputRadioGroup>
                  </div>
                </div>
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <h2 class="accordion-header" id="flush-headingThree">
            <button class="accordion-button collapsed" type="button" @onclick=ToggleAccordionThree data-bs-toggle="collapse" data-bs-target="#flush-collapseThree" aria-expanded="false" aria-controls="flush-collapseThree">
              Capacity and Recharge Rate
            </button>
          </h2>
          <div id="flush-collapseThree" class="accordion-collapse @accordionThreeClass" aria-labelledby="flush-headingThree" data-bs-parent="#accordionFlush">
            <div class="accordion-body">
              <div class="mb-3">
                <label class="control-label">Capacity:</label>
                <InputNumber Value="shield.Capacity" ValueExpression="@(() => shield.Capacity)"
                      name="Capacity" class="form-control" aria-label="Shield Capacity" />
              </div>

              <div class="mb-3">
                <label class="control-label">Recharge Rate:</label>
                <InputNumber Value="shield.RechargeRate" ValueExpression="@(() => shield.RechargeRate)"
                      name="Recharge Rate" class="form-control" aria-label="Shield Recharge Rate" />
              </div>
            </div>
          </div>
        </div>        
        <div class="accordion-item">
          <h2 class="accordion-header" id="flush-headingFive">
            <button class="accordion-button collapsed" @onclick=ToggleAccordionFive type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseFive" aria-expanded="false" aria-controls="flush-collapseFive">
              Custom Image
            </button>
          </h2>
          <div id="flush-collapseFive" class="accordion-collapse @accordionFiveClass" aria-labelledby="flush-headingFive" data-bs-parent="#accordionFlush">
            <div class="accordion-body">
              <div class="mb-3">
                    <div class="mb-3">
                      <label class="control-label">Use Borderlands Manufacturers?</label>
                      <input type="checkbox" checked="@(UseBorderlandsManufacturers)" @onchange="eventArgs => { UseBorderlandsManufacturers = !UseBorderlandsManufacturers; }">
                    </div>  
                    <div class="mb-3">
                      <label class="control-label">Upload Custom Image</label>
                      <input type="checkbox" checked="@(UseCustomImage)" @onchange="eventArgs => { UseCustomImage = !UseCustomImage; }">
                    </div>
                    @if (!UseCustomImage)
                    {
                      <div class="mb-3">
                          <label class="control-label">Card Image URL (Optional):</label>
                          <InputText @bind-Value="shield.ImageUrl" name="ImageUrl" class="form-control" aria-label="Image Url"/>
                      </div>
                    }
                    else
                    {
                      <div class="mb-3">
                          <label class="control-label">Select an Image:</label>
                          <InputFile OnChange="OnFileChange" class="form-control" accept=".png" />                          
                      </div> 
                    }
              </div>
            </div>
          </div>
        </div>
      </div>

    </EditForm>
  </div>

  <div class="col-md-4">
    <ShieldViewer CraftedShield=@shield UseBorderlandsManufacturers=@UseBorderlandsManufacturers/>
  </div>
</div>

@code {
  Shield shield = new Shield
  {
    Name = "My Shield",
    Effect = "None",
    RechargeRate = 0,
    Capacity = 0
  };

  bool UseCustomImage = false;

  bool accordionOneCollapsed = false;
  bool accordionTwoCollapsed = true;
  bool accordionThreeCollapsed = true;
  bool accordionFourCollapsed = true;
  bool accordionFiveCollapsed = true;
  bool UseBorderlandsManufacturers = false;
  
  List<Guild> guilds = null;

  protected override void OnInitialized()
  {
    guilds = guildService.GetGuilds();
    shield.Guild = guilds.First().Name;
  }     

  void FavoriteGuildChanged(string guild)
  {
    var selectedGuild = guilds.First(x => x.Name == guild);
    shield.Guild = selectedGuild.Name;
    shield.AlternateGuildName = selectedGuild.AlternameName;    
    this.StateHasChanged();
  }

  async Task OnFileChange(InputFileChangeEventArgs eventArgs)
    {
        var files = eventArgs.GetMultipleFiles(1);
        var file = files.FirstOrDefault();
        if (file == null)
        {
            return;
        }

        if (file.ContentType == "image/png")
        {
          var resizedFile = await file.RequestImageFileAsync(file.ContentType, 267, 150);
          var buf = new byte[resizedFile.Size];
          using (var stream = resizedFile.OpenReadStream())
          {
            await stream.ReadAsync(buf);
          }
          shield.ImageUrl = $"data:image/png;base64, {Convert.ToBase64String(buf)}";
        }
    }

  void ToggleAccordionOne()
  {
    accordionOneCollapsed = !accordionOneCollapsed;
    this.StateHasChanged();
  }
  
  void ToggleAccordionTwo()
  {
    accordionTwoCollapsed = !accordionTwoCollapsed;
    this.StateHasChanged();
  }
  
  void ToggleAccordionThree()
  {
    accordionThreeCollapsed = !accordionThreeCollapsed;
    this.StateHasChanged();  
  }
  
  void ToggleAccordionFour()
  {
    accordionFourCollapsed = !accordionFourCollapsed;
    this.StateHasChanged();  
  }
  
  void ToggleAccordionFive()
  {
    accordionFiveCollapsed = !accordionFiveCollapsed;
    this.StateHasChanged();  
  }

  string accordionOneClass=> !accordionOneCollapsed? "collapse show": "collapse";
  string accordionTwoClass=> !accordionTwoCollapsed? "collapse show": "collapse";
  string accordionThreeClass=> !accordionThreeCollapsed? "collapse show": "collapse";
  string accordionFourClass=> !accordionFourCollapsed? "collapse show": "collapse";
  string accordionFiveClass=> !accordionFiveCollapsed? "collapse show": "collapse";
}